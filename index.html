<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magyar Darts Pro - Jav√≠tott</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #f39c12; --green: #27ae60; --red: #c0392b; --text: #e0e0e0; --blue: #2980b9; --neon: #39ff14; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        * { box-sizing: border-box; user-select: none; }

        /* --- SETUP SCREEN --- */
        #setup-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; width: 100%; padding: 20px; text-align: center; overflow-y: auto; }
        .setup-group { background: var(--card); padding: 15px; border-radius: 10px; margin-bottom: 15px; width: 100%; max-width: 450px; border: 1px solid #333; }
        h2 { color: var(--accent); margin-top: 0; }
        label { display: block; margin: 10px 0 5px; text-align: left; font-size: 0.9rem; color: #aaa; }
        select, input { width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 5px; font-size: 1rem; margin-bottom: 5px; }
        .btn-add { background: transparent; border: 1px dashed #555; color: #888; padding: 8px; width: 100%; cursor: pointer; margin-top: 5px; }
        .btn-start { background: var(--accent); color: #000; font-weight: bold; padding: 15px 40px; border: none; border-radius: 30px; font-size: 1.5rem; margin-top: 20px; cursor: pointer; box-shadow: 0 0 20px rgba(243, 156, 18, 0.4); width: 100%; max-width: 400px; }

        /* --- GAME SCREEN (Layout m√≥dos√≠tva) --- */
        #game-screen { 
            display: none; 
            width: 100%; 
            max-width: 600px; 
            flex-direction: column; 
            height: 100dvh; /* Dinamikus viewport height mobilra */
            overflow: hidden; /* Fontos: megakad√°lyozza a teljes oldal g√∂rget√©s√©t */
        }
        
        /* Top Info */
        .match-info { display: flex; justify-content: space-between; padding: 8px 15px; background: #000; font-size: 0.85rem; color: #888; border-bottom: 1px solid #333; flex-shrink: 0; }
        
        /* Scoreboard - Tetej√©n, fix magass√°g helyett tartalomhoz igazodik */
        .scoreboard { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            padding: 10px; 
            justify-content: center; 
            align-items: flex-start;
            flex-shrink: 0; /* Nem nyom√≥dik √∂ssze */
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            max-height: 35vh; /* Ha t√∫l sok a j√°t√©kos, a scoreboard g√∂rgessen, ne nyomja el a p√°ly√°t */
            overflow-y: auto;
        }
        .player-card { 
            flex: 1 1 40%; 
            min-width: 140px; 
            background: var(--card); 
            border-radius: 8px; 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            position: relative; 
            border: 2px solid transparent; 
            transition: 0.3s; 
        }
        .player-card.active { border-color: var(--accent); background: #252525; box-shadow: inset 0 0 15px rgba(0,0,0,0.5); transform: scale(1.02); z-index: 10; }
        .p-name { font-size: 1rem; color: #bbb; text-transform: uppercase; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .p-score { font-size: 3rem; font-weight: bold; line-height: 1; margin: 5px 0; color: #fff; }
        .active .p-score { color: var(--accent); }
        .sets-legs { background: #333; padding: 2px 6px; border-radius: 4px; color: #fff; font-size: 0.75rem; margin-top: 5px; }
        
        /* Kisz√°ll√≥ doboz */
        .checkout-box { background: var(--green); color: white; padding: 5px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; margin-top: 5px; display: none; width: 100%; text-align: center; border: 1px solid #1e8449; }

        /* Middle Section - Kit√∂lti a teret √©s k√∂z√©pre igaz√≠t */
        .mid-section { 
            flex: 1 1 auto; /* N√∂vekszik, hogy kit√∂ltse a helyet */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; /* Vertik√°lis k√∂z√©pre igaz√≠t√°s */
            padding: 10px; 
            background: #181818; 
            overflow-y: auto;
            min-height: 0; /* KRITIKUS JAV√çT√ÅS: Engedi a flex elemet √∂sszenyom√≥dni, ha kev√©s a hely */
        }
        .darts-display { display: flex; gap: 15px; margin-bottom: 5px; }
        .dart-slot { width: 50px; height: 50px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; border: 2px solid #444; color: #aaa; }
        .dart-slot.filled { border-color: var(--accent); color: white; background: #444; }
        .visit-score { color: var(--accent); font-size: 1.2rem; font-weight: bold; }
        
        /* F≈ê KISZ√ÅLL√ì */
        #mid-checkout-display { 
            color: var(--neon); 
            font-size: 1.4rem; 
            font-weight: bold; 
            margin-top: 5px; 
            text-shadow: 0 0 5px rgba(57, 255, 20, 0.5); 
            display: none; 
        }

        /* Controls - Alj√°n r√∂gz√≠tve, egys√©ges gombm√©retek */
        .controls-area { 
            background: #1e1e1e; 
            padding: 8px; 
            border-top: 1px solid #333; 
            display: flex; 
            flex-direction: column; 
            gap: 6px; 
            flex-shrink: 0; 
            padding-bottom: max(8px, env(safe-area-inset-bottom)); /* iPhone safe area */
        }
        
        /* Minden gombra vonatkoz√≥ alap be√°ll√≠t√°s az egys√©ges magass√°ghoz */
        .mod-btn, .num-btn, .act-btn, .miss-btn {
            height: 55px; /* Egys√©ges magass√°g */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0; /* Padding reset */
            cursor: pointer;
            font-weight: bold;
            border-radius: 6px;
            border: none;
            color: white;
            transition: 0.2s;
        }

        .mod-row { display: flex; gap: 6px; }
        .mod-btn { flex: 1; font-size: 1.1rem; opacity: 0.3; background: #555; }
        .mod-btn.active { opacity: 1; }
        #btn-double { background: var(--red); }
        #btn-triple { background: var(--green); }
        #btn-camera { background: #555; opacity: 1; }
        #btn-camera.active { background: #e74c3c; }

        .numpad { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; }
        
        .num-btn { grid-column: span 2; background: #3a3a3a; font-size: 1.3rem; }
        .num-btn:active { background: #555; }
        
        .bull-single { grid-column: span 5; background: #27ae60; font-size: 1.3rem; }
        .bull-double { grid-column: span 5; background: #c0392b; font-size: 1.3rem; }
        
        .miss-btn { grid-column: span 10; background: #333; font-size: 1.1rem; border: 1px solid #444; color: #888; }

        .action-row { display: flex; gap: 6px; margin-top: 5px; }
        .act-btn { flex: 1; font-size: 1rem; }
        .btn-undo-dart { background: #7f8c8d; }
        .btn-undo-round { background: #c0392b; font-size: 0.9rem; }
        .btn-next { background: var(--accent); color: black; display: none; font-size: 1.2rem; animation: pulse 1.5s infinite; }
        
        .btn-stats-toggle { background: var(--blue); width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* Camera Box */
        #camera-container { width: 100%; height: 0; overflow: hidden; transition: height 0.3s ease; background: #000; display: flex; justify-content: center; align-items: center; }
        #camera-container.open { height: 200px; margin-bottom: 10px; border-bottom: 2px solid var(--accent); }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; overflow-y: auto; }
        .modal-content { padding: 20px; max-width: 600px; margin: 0 auto; text-align: center; }
        .close-modal { position: fixed; top: 20px; right: 20px; font-size: 2rem; color: var(--red); cursor: pointer; z-index: 101; }
        #win-confirm-modal { align-items: center; justify-content: center; display: none; }
        .win-btn-row { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-confirm-win { background: var(--green); padding: 20px; font-size: 1.2rem; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
        .btn-cancel-win { background: var(--red); padding: 20px; font-size: 1.2rem; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }

        table.stats-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .stats-table th, .stats-table td { border: 1px solid #444; padding: 8px; text-align: center; color: #ddd; }
        .stats-table th { background: #333; color: var(--accent); }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h1>üéØ Magyar Darts Pro</h1>
        <div class="setup-group">
            <h2>J√°t√©kosok</h2>
            <div id="players-container"></div>
            <button class="btn-add" onclick="addPlayerInput()">+ J√°t√©kos hozz√°ad√°sa</button>
            <datalist id="saved-players"></datalist>
        </div>
        <div class="setup-group">
            <h2>Szab√°lyok</h2>
            <div style="display:flex; gap:10px;">
                <select id="start-score"><option value="501" selected>501</option><option value="301">301</option><option value="170">170</option></select>
                <select id="checkout-mode"><option value="double" selected>Dupla kisz√°ll√≥ (DO)</option><option value="straight">Sima kisz√°ll√≥ (SO)</option></select>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="number" id="legs-per-set" value="3" min="1" placeholder="Leg">
                <input type="number" id="sets-to-win" value="1" min="1" placeholder="Szett">
            </div>
        </div>
        <div class="setup-group">
            <h2>Hangok (MP3)</h2>
            <label>180: <input type="file" id="sound-180" accept="audio/*"></label>
            <label>Gy≈ëzelem: <input type="file" id="sound-win" accept="audio/*"></label>
            <label>Bust: <input type="file" id="sound-bust" accept="audio/*"></label>
        </div>
        <button class="btn-start" onclick="startGame()">MECCS IND√çT√ÅSA</button>
    </div>

    <div id="game-screen">
        <div class="match-info">
            <span id="match-config-display">501 DO</span>
            <span id="match-status">Set 1 / Leg 1</span>
        </div>
        <div class="scoreboard" id="scoreboard-container"></div>
        
        <div class="mid-section">
            <div id="camera-container">
                <video id="camera-feed" autoplay playsinline></video>
            </div>
            <div class="darts-display">
                <div class="dart-slot" id="d1"></div>
                <div class="dart-slot" id="d2"></div>
                <div class="dart-slot" id="d3"></div>
            </div>
            <div class="visit-score" id="visit-score">0</div>
            <div id="mid-checkout-display"></div>
        </div>
        
        <div class="controls-area">
            <div class="mod-row">
                <button id="btn-double" class="mod-btn" onclick="toggleMod(2)">DUPLA</button>
                <button id="btn-camera" class="mod-btn" onclick="toggleCamera()">üì∑</button>
                <button id="btn-triple" class="mod-btn" onclick="toggleMod(3)">TRIPLA</button>
            </div>
            <div class="numpad" id="numpad"></div>
            <div class="action-row">
                <button class="act-btn btn-undo-dart" onclick="undoDart()">JAV√çT</button>
                <button class="act-btn btn-undo-round" id="btn-undo-round" onclick="undoRound()" style="display:none;">K√ñR VISSZA</button>
                <button class="act-btn btn-next" id="btn-next" onclick="commitTurn()">K√ñVETKEZ≈ê</button>
            </div>
            <button class="btn-stats-toggle" onclick="showStats()">üìä R√©szletes Statisztika</button>
        </div>
    </div>

    <div id="win-confirm-modal" class="modal" style="background: rgba(0,0,0,0.9);">
        <div class="modal-content" style="border: 2px solid var(--accent);">
            <h1 style="color:var(--accent)">GY≈êZELEM?</h1>
            <h2 id="win-confirm-name" style="color:white"></h2>
            <p>Biztosan kisz√°llt√°l?</p>
            <div class="win-btn-row">
                <button class="btn-cancel-win" onclick="cancelWin()">JAV√çT√ÅS (M√©gsem)</button>
                <button class="btn-confirm-win" onclick="confirmWin()">IGEN, Tov√°bb</button>
            </div>
        </div>
    </div>

    <div id="stats-modal" class="modal">
        <span class="close-modal" onclick="closeStats()">&times;</span>
        <div class="modal-content">
            <h2 style="color:var(--accent)">Statisztik√°k</h2>
            <div id="stats-content"></div>
        </div>
    </div>

    <script>
        const checkouts = {170:"T20 T20 BULL",167:"T20 T19 BULL",164:"T20 T18 BULL",161:"T20 T17 BULL",160:"T20 T20 D20",158:"T20 T20 D19",157:"T20 T19 D20",156:"T20 T20 D18",155:"T20 T19 D19",154:"T20 T18 D20",153:"T20 T19 D18",152:"T20 T20 D16",151:"T20 T17 D20",150:"T20 T18 D18",149:"T20 T19 D16",148:"T20 T16 D20",147:"T20 T17 D18",146:"T20 T18 D16",145:"T20 T15 D20",144:"T20 T20 D12",143:"T20 T17 D16",142:"T20 T14 D20",141:"T20 T19 D12",140:"T20 T16 D16",139:"T20 T13 D20",138:"T20 T18 D12",137:"T19 T16 D16",136:"T20 T20 D8",135:"T20 T15 D15",134:"T20 T14 D16",133:"T20 T19 D8",132:"T20 T16 D12",131:"T20 T13 D16",130:"T20 T18 D8",129:"T19 T16 D12",128:"T18 T14 D16",127:"T20 T17 D8",126:"T19 T19 D6",125:"T18 T13 D16",124:"T20 D16 D16",123:"T19 T16 D9",122:"T18 T20 D4",121:"T20 T15 D8",120:"T20 20 D20",119:"T19 T10 D16",118:"T20 18 D20",117:"T20 17 D20",116:"T20 16 D20",115:"T20 15 D20",114:"T20 14 D20",113:"T20 13 D20",112:"T20 12 D20",111:"T20 19 D16",110:"T20 10 D20",109:"T20 9 D20",108:"T20 16 D16",107:"T19 10 D20",106:"T20 10 D18",105:"T20 13 D16",104:"T18 10 D20",103:"T20 3 D20",102:"T20 10 D16",101:"T17 10 D20",100:"T20 D20",99:"T19 10 D16",98:"T20 D19",97:"T19 D20",96:"T20 D18",95:"T19 D19",94:"T18 D20",93:"T19 D18",92:"T20 D16",91:"T17 D20",90:"T18 D18",89:"T19 D16",88:"T16 D20",87:"T17 D18",86:"T18 D16",85:"T15 D20",84:"T20 D12",83:"T17 D16",82:"T14 D20",81:"T19 D12",80:"T20 D10",79:"T13 D20",78:"T18 D12",77:"T19 D10",76:"T20 D8",75:"T17 D12",74:"T14 D16",73:"T19 D8",72:"T16 D12",71:"T13 D16",70:"T18 D8",69:"T19 D6",68:"T20 D4",67:"T17 D8",66:"T10 D18",65:"T19 D4",64:"T16 D8",63:"T13 D12",62:"T10 D16",61:"T15 D8",60:"20 D20",59:"19 D20",58:"18 D20",57:"17 D20",56:"16 D20",55:"15 D20",54:"14 D20",53:"13 D20",52:"12 D20",51:"19 D16",50:"10 D20",49:"9 D20",48:"16 D16",47:"7 D20",46:"6 D20",45:"13 D16",44:"4 D20",43:"3 D20",42:"6 D18",41:"9 D16",40:"D20",39:"7 D16",38:"D19",37:"5 D16",36:"D18",35:"3 D16",34:"D17",33:"1 D16",32:"D16",31:"7 D12",30:"D15",29:"13 D8",28:"D14",27:"11 D8",26:"D13",25:"9 D8",24:"D12",23:"7 D8",22:"D11",21:"5 D8",20:"D10",19:"3 D8",18:"D9",17:"1 D8",16:"D8",15:"7 D4",14:"D7",13:"5 D4",12:"D6",11:"3 D4",10:"D5",9:"1 D4",8:"D4",7:"3 D2",6:"D3",5:"1 D2",4:"D2",3:"1 D1",2:"D1"};

        let state = {
            players: [], currIdx: 0, startIdx: 0,
            config: {}, currentVisit: [], multiplier: 1,
            historyStack: [], isProcessing: false,
            cameraActive: false, stream: null
        };
        let sounds = { s180: null, win: null, bust: null };

        window.onload = () => {
            initNumpad();
            loadSavedPlayers();
            addPlayerInput(); addPlayerInput();
            ['180', 'win', 'bust'].forEach(t => {
                document.getElementById(`sound-${t}`).addEventListener('change', e => {
                    let f = e.target.files[0]; if(f) sounds['s'+t] = new Audio(URL.createObjectURL(f));
                });
            });
        };

        function toggleCamera() {
            let container = document.getElementById('camera-container');
            let btn = document.getElementById('btn-camera');
            let video = document.getElementById('camera-feed');

            if (!state.cameraActive) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    state.stream = stream; video.srcObject = stream;
                    state.cameraActive = true; container.classList.add('open'); btn.classList.add('active');
                })
                .catch(err => { alert("Kamera hiba: " + err); });
            } else {
                if (state.stream) { state.stream.getTracks().forEach(track => track.stop()); }
                video.srcObject = null; state.cameraActive = false;
                container.classList.remove('open'); btn.classList.remove('active');
            }
        }

        function initNumpad() {
            let np = document.getElementById('numpad');
            // 1-20 gombok
            for(let i=1; i<=20; i++){
                let b = document.createElement('button');
                b.className = 'num-btn'; b.innerText = i;
                b.onclick = () => addDart(i);
                np.appendChild(b);
            }
            // 25 (Sima Bull)
            let b25 = document.createElement('button');
            b25.className = 'num-btn bull-single'; b25.innerText = '25';
            b25.onclick = () => addDart(25);
            np.appendChild(b25);
            // 50 (Bullseye)
            let b50 = document.createElement('button');
            b50.className = 'num-btn bull-double'; b50.innerText = '50';
            b50.onclick = () => addDart(50);
            np.appendChild(b50);
            // MISS
            let miss = document.createElement('button');
            miss.className = 'num-btn miss-btn'; miss.innerText = 'MISS (0)';
            miss.onclick = () => addDart(0);
            np.appendChild(miss);
        }

        function loadSavedPlayers() {
            let saved = JSON.parse(localStorage.getItem('dartsPlayers')) || [];
            let list = document.getElementById('saved-players');
            saved.forEach(name => {
                let opt = document.createElement('option'); opt.value = name; list.appendChild(opt);
            });
        }
        function addPlayerInput() {
            let container = document.getElementById('players-container');
            let idx = container.children.length + 1;
            let inp = document.createElement('input');
            inp.type = "text"; inp.placeholder = `J√°t√©kos ${idx} neve`; inp.className = "player-input"; inp.setAttribute('list', 'saved-players');
            container.appendChild(inp);
        }

        function startGame() {
            let inputs = document.querySelectorAll('.player-input');
            let validPlayers = [];
            inputs.forEach(inp => { if(inp.value.trim()) validPlayers.push(inp.value.trim()); });
            if(validPlayers.length < 1) return alert("Legal√°bb 1 j√°t√©kos kell!");
            
            // Ment√©s
            let saved = JSON.parse(localStorage.getItem('dartsPlayers')) || [];
            validPlayers.forEach(name => { if(!saved.includes(name)) saved.push(name); });
            localStorage.setItem('dartsPlayers', JSON.stringify(saved));

            state.config = {
                startScore: parseInt(document.getElementById('start-score').value),
                doubleOut: document.getElementById('checkout-mode').value === 'double',
                legsSet: parseInt(document.getElementById('legs-per-set').value),
                setsWin: parseInt(document.getElementById('sets-to-win').value)
            };
            state.players = validPlayers.map(name => ({
                name: name, score: state.config.startScore, legs: 0, sets: 0, totalScore: 0, totalDarts: 0, hits: {}
            }));
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('match-config-display').innerText = `${state.config.startScore} ${state.config.doubleOut ? 'DO' : 'SO'}`;
            renderScoreboard(); updateUI();
        }

        function toggleMod(m) {
            state.multiplier = (state.multiplier === m) ? 1 : m;
            updateUI();
        }

        function addDart(val) {
            if(state.currentVisit.length >= 3 || state.isProcessing) return;

            let mod = state.multiplier;
            let score = val * mod;
            let text = val; 
            let hitKey = val;

            if(val === 0) { score = 0; text = "MISS"; hitKey = "0"; }
            else if(val === 25) {
                // Sima Bull (25)
                score = 25; text = "25"; hitKey="SBull";
                // Ha v√©letlen√ºl dupl√°t/tripl√°t nyomott el≈ëtte, ignor√°ljuk, vagy vegy√ºk √∫gy, hogy a felhaszn√°l√≥ d√∂nt√∂tt a gombbal
                state.multiplier = 1; 
            }
            else if(val === 50) {
                // Bullseye (50)
                score = 50; text = "BULL"; hitKey="DBull";
                state.multiplier = 1;
            }
            else {
                // 1-20
                if(mod === 2) { text = "D"+val; hitKey="D"+val; }
                else if(mod === 3) { text = "T"+val; hitKey="T"+val; }
                else { hitKey="S"+val; }
            }

            let dart = { score, text, mod, raw: val, key: hitKey };
            state.currentVisit.push(dart);
            state.multiplier = 1; // Reset modifier

            // Ellen≈ërz√©s
            let p = state.players[state.currIdx];
            let visitSum = state.currentVisit.reduce((a,b)=>a+b.score, 0);
            let remainder = p.score - visitSum;

            // BUST
            let isBust = false;
            if (remainder < 0) isBust = true;
            else if (state.config.doubleOut) {
                if (remainder === 1) isBust = true;
                // Ha 0, de nem dupl√°val
                if (remainder === 0) {
                    // Utols√≥ dob√°s vizsg√°lata. 
                    // Ha a gomb 50 volt (val===50) vagy a mod volt 2
                    let last = state.currentVisit[state.currentVisit.length-1];
                    let isDouble = (last.mod === 2 && last.raw <= 20) || (last.raw === 50); // 50 is double bull
                    if (!isDouble) isBust = true;
                }
            }

            if(isBust) { updateUI(); handleBust(); return; }

            // WIN
            if(remainder === 0) {
                updateUI(); playSound("win", "Kisz√°ll√≥ megvan!");
                document.getElementById('win-confirm-name').innerText = p.name;
                document.getElementById('win-confirm-modal').style.display = 'flex';
                return;
            }

            if(score === 60 || score === 50) playSound("hit");
            updateUI();
        }

        function confirmWin() { document.getElementById('win-confirm-modal').style.display = 'none'; commitTurn(true); }
        function cancelWin() { document.getElementById('win-confirm-modal').style.display = 'none'; undoDart(); }

        function handleBust() {
            state.isProcessing = true; playSound("bust", "Sok!");
            setTimeout(() => {
                let p = state.players[state.currIdx];
                state.currentVisit.forEach(d => {
                    p.totalDarts++; if(!p.hits[d.key]) p.hits[d.key]=0; p.hits[d.key]++;
                });
                state.currentVisit = [];
                state.currIdx = (state.currIdx + 1) % state.players.length;
                state.isProcessing = false; updateUI();
            }, 1500);
        }

        function undoDart() { if(state.currentVisit.length>0 && !state.isProcessing) { state.currentVisit.pop(); updateUI(); } }
        function undoRound() {
            if(state.historyStack.length>0 && !state.isProcessing) {
                let prev = state.historyStack.pop();
                let savedStack = state.historyStack;
                state = prev; state.historyStack = savedStack;
                renderScoreboard(); updateUI();
            }
        }

        function commitTurn(forceWin=false) {
            if(state.isProcessing) return;
            let snap = JSON.parse(JSON.stringify(state)); delete snap.historyStack; delete snap.stream;
            state.historyStack.push(snap); if(state.historyStack.length>10) state.historyStack.shift();

            let p = state.players[state.currIdx];
            let total = state.currentVisit.reduce((a,b)=>a+b.score, 0);
            state.currentVisit.forEach(d => {
                p.totalDarts++; p.totalScore+=d.score;
                if(!p.hits[d.key]) p.hits[d.key]=0; p.hits[d.key]++;
            });
            p.score -= total;

            if(forceWin || p.score===0) {
                handleLegWin(p);
            } else {
                if(total===180) playSound("s180", "Sz√°znyolcvan!"); else playSound(total);
                state.currentVisit=[];
                state.currIdx = (state.currIdx+1) % state.players.length;
                updateUI();
            }
        }

        function handleLegWin(p) {
            p.legs++; state.currentVisit=[];
            if(p.legs >= state.config.legsSet) {
                p.sets++; state.players.forEach(pl=>pl.legs=0);
                if(p.sets >= state.config.setsWin) {
                    setTimeout(()=>alert(`üèÜ ${p.name} NYERT! üèÜ`), 500); return;
                }
            }
            setTimeout(() => {
                alert(`Leg: ${p.name}`);
                state.players.forEach(pl=>pl.score = state.config.startScore);
                state.startIdx = (state.startIdx+1) % state.players.length;
                state.currIdx = state.startIdx;
                state.historyStack=[]; updateUI();
            }, 300);
        }

        function renderScoreboard() {
            let container = document.getElementById('scoreboard-container'); container.innerHTML = "";
            let midCheckout = document.getElementById('mid-checkout-display'); 
            midCheckout.innerText = "";
            midCheckout.style.display = "none";

            state.players.forEach((p, idx) => {
                let div = document.createElement('div');
                div.className = `player-card ${idx === state.currIdx ? 'active' : ''}`;
                
                // DINAMIKUS PONT KIJELZ√âS (M√°r levonva az aktu√°lis dob√°st)
                let displayScore = p.score;
                if(idx === state.currIdx) {
                    let visitSum = state.currentVisit.reduce((a,b)=>a+b.score, 0);
                    displayScore -= visitSum;
                }

                // KISZ√ÅLL√ì B√ÅRKINEK
                let coHtml = "";
                if(state.config.doubleOut && displayScore <= 170 && checkouts[displayScore]) {
                    coHtml = `<div class="checkout-box" style="display:block">${checkouts[displayScore]}</div>`;
                    if(idx === state.currIdx) {
                        midCheckout.innerText = "KISZ√ÅLL√ì: " + checkouts[displayScore];
                        midCheckout.style.display = "block";
                    }
                }

                div.innerHTML = `
                    <div class="p-name">${p.name}</div>
                    <div class="p-score">${displayScore}</div>
                    <div class="sets-legs">S:${p.sets} | L:${p.legs}</div>
                    ${coHtml}
                `;
                container.appendChild(div);
            });
        }

        function updateUI() {
            renderScoreboard();
            for(let i=0; i<3; i++){
                let slot = document.getElementById(`d${i+1}`);
                if(state.currentVisit[i]) { slot.innerText=state.currentVisit[i].text; slot.classList.add('filled'); }
                else { slot.innerText=""; slot.classList.remove('filled'); }
            }
            let vTot = state.currentVisit.reduce((a,b)=>a+b.score, 0);
            document.getElementById('visit-score').innerText = vTot;

            let isFull = state.currentVisit.length===3;
            document.getElementById('numpad').style.pointerEvents = (isFull||state.isProcessing)?'none':'auto';
            document.getElementById('numpad').style.opacity = (isFull||state.isProcessing)?0.5:1;
            document.getElementById('btn-next').style.display = isFull?'block':'none';
            document.getElementById('btn-undo-round').style.display = (state.historyStack.length>0 && !isFull && state.currentVisit.length===0)?'block':'none';
            
            document.getElementById('btn-double').classList.toggle('active', state.multiplier===2);
            document.getElementById('btn-triple').classList.toggle('active', state.multiplier===3);
        }

        function showStats() {
            let content = document.getElementById('stats-content'); let html = "";
            state.players.forEach(p => {
                let avg = p.totalDarts > 0 ? (p.totalScore/p.totalDarts*3).toFixed(2) : "0.00";
                html += `<div style="margin-bottom:20px; border:1px solid #444; padding:10px; border-radius:5px;">
                    <h3 style="color:#f39c12; margin:0;">${p.name}</h3><p>√Åtlag: <strong>${avg}</strong></p>
                    <table class="stats-table"><tr><th>Dob√°s</th><th>Darab</th></tr>`;
                let sorted = Object.entries(p.hits).sort((a,b)=>b[1]-a[1]);
                sorted.forEach(([k,v])=>{html+=`<tr><td>${k}</td><td>${v}</td></tr>`});
                if(sorted.length===0) html+="<tr><td colspan='2'>-</td></tr>"; html+=`</table></div>`;
            });
            content.innerHTML = html; document.getElementById('stats-modal').style.display="block";
        }
        function closeStats(){document.getElementById('stats-modal').style.display="none";}

        function playSound(key, fallback) {
            if(key==="s180" && sounds.s180){sounds.s180.play(); return;}
            if(key==="win" && sounds.win){sounds.win.play(); return;}
            if(key==="bust" && sounds.bust){sounds.bust.play(); return;}
            if(typeof key==='number'){
                let u = new SpeechSynthesisUtterance(key.toString()); u.lang='hu-HU'; u.rate=1.1; window.speechSynthesis.speak(u);
            }
        }
    </script>
</body>
</html>