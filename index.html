<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>D√°Ci Darts Club Darts League</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #f39c12; --green: #27ae60; --red: #c0392b; --text: #e0e0e0; --blue: #2980b9; --neon: #39ff14; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        * { box-sizing: border-box; user-select: none; }

        /* --- SETUP SCREEN --- */
        #setup-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; width: 100%; padding: 20px; text-align: center; overflow-y: auto; }
        .setup-group { background: var(--card); padding: 15px; border-radius: 10px; margin-bottom: 15px; width: 100%; max-width: 450px; border: 1px solid #333; }
        h2 { color: var(--accent); margin-top: 0; }
        label { display: block; margin: 10px 0 5px; text-align: left; font-size: 0.9rem; color: #aaa; }
        select, input { width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 5px; font-size: 1rem; margin-bottom: 5px; }
        .btn-add { background: transparent; border: 1px dashed #555; color: #888; padding: 8px; width: 100%; cursor: pointer; margin-top: 5px; }
        .btn-start { background: var(--accent); color: #000; font-weight: bold; padding: 15px 40px; border: none; border-radius: 30px; font-size: 1.5rem; margin-top: 20px; cursor: pointer; box-shadow: 0 0 20px rgba(243, 156, 18, 0.4); width: 100%; max-width: 400px; }

        /* --- GAME SCREEN --- */
        #game-screen { 
            display: none; width: 100%; max-width: 600px; flex-direction: column; 
            height: 100vh; height: 100dvh; overflow: hidden; 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        }
        
        .match-info { display: flex; justify-content: space-between; padding: 2px 10px; background: #000; font-size: 0.7rem; color: #888; border-bottom: 1px solid #333; flex-shrink: 0; }
        
        .scoreboard { 
            display: flex; flex-wrap: wrap; gap: 5px; padding: 5px; justify-content: center; align-items: flex-start;
            flex: 0 0 auto; background: #1a1a1a; border-bottom: 1px solid #333; max-height: 20vh; overflow-y: auto;
        }
        .player-card { 
            flex: 1 1 45%; min-width: 100px; background: var(--card); border-radius: 6px; padding: 5px; 
            display: flex; flex-direction: column; align-items: center; position: relative; border: 2px solid transparent; transition: 0.3s; 
        }
        .player-card.active { border-color: var(--accent); background: #252525; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .p-name { font-size: 0.8rem; color: #bbb; text-transform: uppercase; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .p-score { font-size: 1.8rem; font-weight: bold; line-height: 1; margin: 2px 0; color: #fff; }
        .active .p-score { color: var(--accent); }
        .sets-legs { background: #333; padding: 1px 5px; border-radius: 3px; color: #fff; font-size: 0.65rem; margin-top: 2px; }
        .p-avg { font-size: 0.7rem; color: var(--blue); margin-top: 2px; font-weight: bold; }
        
        .checkout-box { background: var(--green); color: white; padding: 2px; border-radius: 3px; font-weight: bold; font-size: 0.75rem; margin-top: 2px; display: none; width: 100%; text-align: center; }

        .mid-section { 
            flex: 1 1 0; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            padding: 5px; background: #181818; overflow-y: auto; min-height: 0; 
        }
        .darts-display { display: flex; gap: 10px; margin-bottom: 5px; }
        .dart-slot { width: 60px; height: 60px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; border: 2px solid #444; color: #aaa; }
        .dart-slot.filled { border-color: var(--accent); color: white; background: #444; }
        .visit-score { color: var(--accent); font-size: 2rem; font-weight: bold; }
        #mid-checkout-display { color: var(--neon); font-size: 1.6rem; font-weight: bold; margin-top: 5px; text-shadow: 0 0 5px rgba(57, 255, 20, 0.5); display: none; }

        .controls-area { 
            background: #1e1e1e; padding: 5px; border-top: 1px solid #333; display: flex; flex-direction: column; gap: 4px; 
            flex: 0 0 auto; padding-bottom: max(5px, env(safe-area-inset-bottom));
        }
        
        .mod-btn, .num-btn, .act-btn, .miss-btn, .stat-btn-small {
            height: 48px; display: flex; align-items: center; justify-content: center;
            padding: 0; cursor: pointer; font-weight: bold; border-radius: 5px; border: none; color: white; transition: 0.1s;
        }

        .mod-row { display: flex; gap: 4px; }
        .mod-btn { flex: 1; font-size: 1rem; opacity: 0.3; background: #555; }
        .mod-btn.active { opacity: 1; }
        #btn-double { background: var(--red); }
        #btn-triple { background: var(--green); }
        
        .numpad { display: grid; grid-template-columns: repeat(10, 1fr); gap: 3px; }
        .num-btn { grid-column: span 2; background: #3a3a3a; font-size: 1.2rem; }
        .num-btn:active { background: #555; transform: scale(0.95); }
        .bull-single { grid-column: span 5; background: #27ae60; font-size: 1.1rem; }
        .bull-double { grid-column: span 5; background: #c0392b; font-size: 1.1rem; }
        .miss-btn { grid-column: span 10; background: #333; font-size: 1rem; border: 1px solid #444; color: #888; padding: 10px 0; height: 48px; }

        .action-row { display: flex; gap: 4px; margin-top: 0; }
        .act-btn { flex: 1; font-size: 0.9rem; }
        .btn-undo-dart { background: #7f8c8d; }
        .btn-undo-round { background: #c0392b; font-size: 0.8rem; }
        .btn-next { background: var(--accent); color: black; display: none; font-size: 1rem; animation: pulse 1.5s infinite; }
        .stat-btn-small { background: var(--blue); width: 45px; font-size: 1.2rem; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        #camera-container { width: 100%; display: none; background: #000; justify-content: center; align-items: center; margin-bottom: 5px; border-bottom: 2px solid var(--accent); }
        #camera-container.open { display: flex; height: 160px; flex-shrink: 0; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; overflow-y: auto; }
        .modal-content { padding: 10px; max-width: 800px; margin: 0 auto; text-align: center; }
        .close-modal { position: fixed; top: 20px; right: 20px; font-size: 2rem; color: var(--red); cursor: pointer; z-index: 201; }
        #win-confirm-modal { align-items: center; justify-content: center; display: none; }
        .win-btn-row { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-confirm-win { background: var(--green); padding: 15px; font-size: 1.1rem; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
        .btn-cancel-win { background: var(--red); padding: 15px; font-size: 1.1rem; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }

        /* STATS STYLING */
        .stats-container { display: flex; flex-direction: column; gap: 20px; color: white; text-align: left; padding-top: 40px; }
        .stats-tabs { display: flex; gap: 10px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .stat-tab { background: #333; border: 1px solid #555; color: #aaa; padding: 8px 15px; border-radius: 20px; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .stat-tab.active { background: var(--accent); color: black; font-weight: bold; border-color: var(--accent); }
        
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-box { background: #222; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: var(--accent); }
        .stat-lbl { font-size: 0.8rem; color: #888; }

        .history-list { display: flex; flex-direction: column; gap: 10px; }
        .history-item { background: #222; padding: 10px; border-radius: 5px; border-left: 4px solid var(--accent); }
        .h-date { font-size: 0.75rem; color: #888; }
        .h-match { font-size: 1rem; font-weight: bold; color: white; }
        .h-score { color: var(--green); float: right; font-weight: bold; }

        /* Heatmap */
        #heatmap-container { width: 100%; max-width: 400px; margin: 0 auto; position: relative; display: block; background: #222; border-radius: 50%; overflow: hidden;}
        svg { width: 100%; height: auto; display: block; }
        .sector-path { stroke: #333; stroke-width: 1px; transition: fill 0.2s; }
        .sector-text { font-size: 12px; fill: #fff; text-anchor: middle; dominant-baseline: middle; pointer-events: none; font-weight: bold; }

        /* Sortable Table */
        .sortable-th { cursor: pointer; user-select: none; position: relative; padding-right: 15px; }
        .sortable-th:hover { color: var(--accent); }
        .sortable-th::after { content: '‚Üï'; position: absolute; right: 2px; opacity: 0.3; font-size: 0.8rem; }
        .sortable-th.asc::after { content: '‚Üë'; opacity: 1; }
        .sortable-th.desc::after { content: '‚Üì'; opacity: 1; }
        
        table.stats-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .stats-table th, .stats-table td { border: 1px solid #444; padding: 8px; text-align: center; color: #ddd; }
        .stats-table th { background: #333; color: var(--accent); }
        .stats-table tr:nth-child(even) { background: #2a2a2a; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h1>‡™ú‚ÅÄ‚û¥ üéØ D√°Ci Darts Club Darts League ‚ÅÄ‚û¥üéØ</h1>
        <div class="setup-group">
            <h2>J√°t√©kosok</h2>
            <div id="players-container"></div>
            <button class="btn-add" onclick="addPlayerInput()">+ J√°t√©kos hozz√°ad√°sa</button>
            <datalist id="saved-players"></datalist>
        </div>
        <div class="setup-group">
            <h2>Szab√°lyok</h2>
            <div style="display:flex; gap:10px;">
                <select id="start-score"><option value="501" selected>501</option><option value="301">301</option><option value="170">170</option></select>
                <select id="checkout-mode"><option value="double" selected>Dupla kisz√°ll√≥ (DO)</option><option value="straight">Sima kisz√°ll√≥ (SO)</option></select>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="number" id="legs-per-set" value="3" min="1" placeholder="Leg">
                <input type="number" id="sets-to-win" value="1" min="1" placeholder="Szett">
            </div>
        </div>
        <div class="setup-group">
            <h2>Hangok (MP3)</h2>
            <label>180: <input type="file" id="sound-180" accept="audio/*"></label>
            <label>Gy≈ëzelem: <input type="file" id="sound-win" accept="audio/*"></label>
            <label>Bust: <input type="file" id="sound-bust" accept="audio/*"></label>
        </div>
        <button class="btn-start" onclick="startGame()">MECCS IND√çT√ÅSA</button>
    </div>

    <div id="game-screen">
        <div class="match-info">
            <span id="match-config-display">501 DO</span>
            <span id="match-status">Set 1 / Leg 1</span>
        </div>
        <div class="scoreboard" id="scoreboard-container"></div>
        
        <div class="mid-section">
            <div class="darts-display">
                <div class="dart-slot" id="d1"></div>
                <div class="dart-slot" id="d2"></div>
                <div class="dart-slot" id="d3"></div>
            </div>
            <div class="visit-score" id="visit-score">0</div>
            <div id="mid-checkout-display"></div>
        </div>
        
        <div class="controls-area">
            <div class="mod-row">
                <button id="btn-double" class="mod-btn" onclick="toggleMod(2)">DUPLA</button>
                <button id="btn-triple" class="mod-btn" onclick="toggleMod(3)">TRIPLA</button>
            </div>
            <div class="numpad" id="numpad"></div>
            <div class="action-row">
                <button class="act-btn btn-undo-dart" onclick="undoDart()">JAV√çT</button>
                <button class="act-btn btn-undo-round" id="btn-undo-round" onclick="undoRound()" style="display:none;">K√ñR VISSZA</button>
                <button class="act-btn btn-next" id="btn-next" onclick="commitTurn()">K√ñVETKEZ≈ê</button>
                <button class="stat-btn-small" onclick="showStats()">üìä</button>
            </div>
        </div>
    </div>

    <div id="win-confirm-modal" class="modal" style="background: rgba(0,0,0,0.9);">
        <div class="modal-content" style="border: 2px solid var(--accent);">
            <h1 style="color:var(--accent)">GY≈êZELEM?</h1>
            <h2 id="win-confirm-name" style="color:white"></h2>
            <p>Biztosan kisz√°llt√°l?</p>
            <div class="win-btn-row">
                <button class="btn-cancel-win" onclick="cancelWin()">JAV√çT√ÅS (M√©gsem)</button>
                <button class="btn-confirm-win" onclick="confirmWin()">IGEN, Tov√°bb</button>
            </div>
        </div>
    </div>

    <div id="stats-modal" class="modal">
        <span class="close-modal" onclick="closeStats()">&times;</span>
        <div class="modal-content">
            <h2 style="color:var(--accent); margin-bottom:5px;">Statisztik√°k</h2>
            <div id="stats-nav" class="stats-tabs"></div>
            <div id="stats-body" class="stats-container"></div>
        </div>
    </div>

    <script>
        const checkouts = {170:"T20 T20 BULL",167:"T20 T19 BULL",164:"T20 T18 BULL",161:"T20 T17 BULL",160:"T20 T20 D20",158:"T20 T20 D19",157:"T20 T19 D20",156:"T20 T20 D18",155:"T20 T19 D19",154:"T20 T18 D20",153:"T20 T19 D18",152:"T20 T20 D16",151:"T20 T17 D20",150:"T20 T18 D18",149:"T20 T19 D16",148:"T20 T16 D20",147:"T20 T17 D18",146:"T20 T18 D16",145:"T20 T15 D20",144:"T20 T20 D12",143:"T20 T17 D16",142:"T20 T14 D20",141:"T20 T19 D12",140:"T20 T16 D16",139:"T20 T13 D20",138:"T20 T18 D12",137:"T19 T16 D16",136:"T20 T20 D8",135:"T20 T15 D15",134:"T20 T14 D16",133:"T20 T19 D8",132:"T20 T16 D12",131:"T20 T13 D16",130:"T20 T18 D8",129:"T19 T16 D12",128:"T18 T14 D16",127:"T20 T17 D8",126:"T19 T19 D6",125:"T18 T13 D16",124:"T20 D16 D16",123:"T19 T16 D9",122:"T18 T20 D4",121:"T20 T15 D8",120:"T20 20 D20",119:"T19 T10 D16",118:"T20 18 D20",117:"T20 17 D20",116:"T20 16 D20",115:"T20 15 D20",114:"T20 14 D20",113:"T20 13 D20",112:"T20 12 D20",111:"T20 19 D16",110:"T20 10 D20",109:"T20 9 D20",108:"T20 16 D16",107:"T19 10 D20",106:"T20 10 D18",105:"T20 13 D16",104:"T18 10 D20",103:"T20 3 D20",102:"T20 10 D16",101:"T17 10 D20",100:"T20 D20",99:"T19 10 D16",98:"T20 D19",97:"T19 D20",96:"T20 D18",95:"T19 D19",94:"T18 D20",93:"T19 D18",92:"T20 D16",91:"T17 D20",90:"T18 D18",89:"T19 D16",88:"T16 D20",87:"T17 D18",86:"T18 D16",85:"T15 D20",84:"T20 D12",83:"T17 D16",82:"T14 D20",81:"T19 D12",80:"T20 D10",79:"T13 D20",78:"T18 D12",77:"T19 D10",76:"T20 D8",75:"T17 D12",74:"T14 D16",73:"T19 D8",72:"T16 D12",71:"T13 D16",70:"T18 D8",69:"T19 D6",68:"T20 D4",67:"T17 D8",66:"T10 D18",65:"T19 D4",64:"T16 D8",63:"T13 D12",62:"T10 D16",61:"T15 D8",60:"20 D20",59:"19 D20",58:"18 D20",57:"17 D20",56:"16 D20",55:"15 D20",54:"14 D20",53:"13 D20",52:"12 D20",51:"19 D16",50:"10 D20",49:"9 D20",48:"16 D16",47:"7 D20",46:"6 D20",45:"13 D16",44:"4 D20",43:"3 D20",42:"6 D18",41:"9 D16",40:"D20",39:"7 D16",38:"D19",37:"5 D16",36:"D18",35:"3 D16",34:"D17",33:"1 D16",32:"D16",31:"7 D12",30:"D15",29:"13 D8",28:"D14",27:"11 D8",26:"D13",25:"9 D8",24:"D12",23:"7 D8",22:"D11",21:"5 D8",20:"D10",19:"3 D8",18:"D9",17:"1 D8",16:"D8",15:"7 D4",14:"D7",13:"5 D4",12:"D6",11:"3 D4",10:"D5",9:"1 D4",8:"D4",7:"3 D2",6:"D3",5:"1 D2",4:"D2",3:"1 D1",2:"D1"};

        let state = {
            players: [], currIdx: 0, startIdx: 0,
            config: {}, currentVisit: [], multiplier: 1,
            historyStack: [], isProcessing: false,
            stream: null
        };
        let sounds = { s180: null, win: null, bust: null };
        const sectorOrder = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];
        let throwSort = { col: 'count', asc: false };

        window.onload = () => {
            initNumpad();
            loadSavedPlayers();
            addPlayerInput(); addPlayerInput();
            ['180', 'win', 'bust'].forEach(t => {
                document.getElementById(`sound-${t}`).addEventListener('change', e => {
                    let f = e.target.files[0]; if(f) sounds['s'+t] = new Audio(URL.createObjectURL(f));
                });
            });
        };

        function initNumpad() {
            let np = document.getElementById('numpad');
            for(let i=1; i<=20; i++){
                let b = document.createElement('button');
                b.className = 'num-btn'; b.innerText = i;
                b.onclick = () => addDart(i);
                np.appendChild(b);
            }
            let b25 = document.createElement('button');
            b25.className = 'num-btn bull-single'; b25.innerText = '25';
            b25.onclick = () => addDart(25);
            np.appendChild(b25);
            let b50 = document.createElement('button');
            b50.className = 'num-btn bull-double'; b50.innerText = '50';
            b50.onclick = () => addDart(50);
            np.appendChild(b50);
            let miss = document.createElement('button');
            miss.className = 'num-btn miss-btn'; miss.innerText = 'MISS (0)';
            miss.onclick = () => addDart(0);
            np.appendChild(miss);
        }

        function loadSavedPlayers() {
            let saved = JSON.parse(localStorage.getItem('dartsPlayers')) || [];
            let list = document.getElementById('saved-players');
            saved.forEach(name => {
                let opt = document.createElement('option'); opt.value = name; list.appendChild(opt);
            });
        }
        function addPlayerInput() {
            let container = document.getElementById('players-container');
            let idx = container.children.length + 1;
            let inp = document.createElement('input');
            inp.type = "text"; inp.placeholder = `J√°t√©kos ${idx} neve`; inp.className = "player-input"; inp.setAttribute('list', 'saved-players');
            container.appendChild(inp);
        }

        // --- STATS LOGIC ---
        function getPersistentStats() { return JSON.parse(localStorage.getItem('dartsGlobalStats')) || {}; }
        function savePersistentStats(stats) { localStorage.setItem('dartsGlobalStats', JSON.stringify(stats)); }
        function getMatchHistory() { return JSON.parse(localStorage.getItem('dartsMatchHistory')) || []; }
        function saveMatchHistory(history) { localStorage.setItem('dartsMatchHistory', JSON.stringify(history)); }

        // Ments√ºk az egyes dob√°st az √∂sszes√≠tettbe
        function recordDartStat(playerName, dart) {
            let allStats = getPersistentStats();
            let p = allStats[playerName] || { 
                totalScore: 0, totalDarts: 0, wins: 0, matches: 0,
                bestLeg: 999, highestCheckout: 0, hits: {},
                c100: 0, c140: 0, c180: 0
            };
            p.totalDarts++; p.totalScore += dart.score;
            let key = dart.key;
            if(!p.hits[key]) p.hits[key] = 0; p.hits[key]++;
            
            // Ment√©s vissza a localStorage-ba
            allStats[playerName] = p; // Fontos: friss√≠ts√ºk a j√°t√©kos objektumot
            savePersistentStats(allStats);
        }
        
        function recordVisitStat(playerName, visitTotal) {
            let allStats = getPersistentStats();
            let p = allStats[playerName]; if(!p) return;
            if(visitTotal === 180) p.c180++;
            else if(visitTotal >= 140) p.c140++;
            else if(visitTotal >= 100) p.c100++;
            
            allStats[playerName] = p;
            savePersistentStats(allStats);
        }
        
        function recordLegWin(playerName, dartCount, checkoutScore) {
            let allStats = getPersistentStats();
            let p = allStats[playerName]; if(!p) return;
            p.wins++;
            if(dartCount < p.bestLeg) p.bestLeg = dartCount;
            if(checkoutScore > p.highestCheckout) p.highestCheckout = checkoutScore;
            
            allStats[playerName] = p;
            savePersistentStats(allStats);
        }

        // Meccs v√©g√©n ment√©s a napl√≥ba
        function saveMatchEnd(winnerName) {
            let history = getMatchHistory();
            let matchData = {
                date: new Date().toLocaleString('hu-HU'),
                winner: winnerName,
                players: state.players.map(p => ({
                    name: p.name,
                    avg: p.totalDarts > 0 ? (p.totalScore / p.totalDarts * 3).toFixed(2) : "0.00",
                    score: p.sets + " (" + p.legs + ")", // Set √©s leg v√©geredm√©ny
                    hits: p.hits // Az adott meccs dob√°s statisztik√°ja!
                }))
            };
            history.unshift(matchData); // Elej√©re sz√∫rjuk be
            if(history.length > 50) history.pop(); // Max 50 meccs
            saveMatchHistory(history);
        }

        function startGame() {
            let inputs = document.querySelectorAll('.player-input');
            let validPlayers = [];
            inputs.forEach(inp => { if(inp.value.trim()) validPlayers.push(inp.value.trim()); });
            if(validPlayers.length < 1) return alert("Legal√°bb 1 j√°t√©kos kell!");
            
            let saved = JSON.parse(localStorage.getItem('dartsPlayers')) || [];
            validPlayers.forEach(name => { if(!saved.includes(name)) saved.push(name); });
            localStorage.setItem('dartsPlayers', JSON.stringify(saved));

            state.config = {
                startScore: parseInt(document.getElementById('start-score').value),
                doubleOut: document.getElementById('checkout-mode').value === 'double',
                legsSet: parseInt(document.getElementById('legs-per-set').value),
                setsWin: parseInt(document.getElementById('sets-to-win').value)
            };
            state.players = validPlayers.map(name => ({
                name: name, score: state.config.startScore, legs: 0, sets: 0, totalScore: 0, totalDarts: 0, hits: {},
                currentLegDarts: 0
            }));
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('match-config-display').innerText = `${state.config.startScore} ${state.config.doubleOut ? 'DO' : 'SO'}`;
            renderScoreboard(); updateUI();
        }

        function toggleMod(m) { state.multiplier = (state.multiplier === m) ? 1 : m; updateUI(); }

        function addDart(val) {
            if(state.currentVisit.length >= 3 || state.isProcessing) return;

            let mod = state.multiplier;
            let score = val * mod;
            let text = val; let hitKey = val;

            if(val === 0) { score = 0; text = "MISS"; hitKey = "0"; }
            else if(val === 25) { score = 25; text = "25"; hitKey="SBull"; state.multiplier = 1; }
            else if(val === 50) { score = 50; text = "BULL"; hitKey="DBull"; state.multiplier = 1; }
            else {
                if(mod === 2) { text = "D"+val; hitKey="D"+val; }
                else if(mod === 3) { text = "T"+val; hitKey="T"+val; }
                else { hitKey="S"+val; }
            }

            let dart = { score, text, mod, raw: val, key: hitKey };
            state.currentVisit.push(dart);
            state.multiplier = 1;

            let p = state.players[state.currIdx];
            let visitSum = state.currentVisit.reduce((a,b)=>a+b.score, 0);
            let remainder = p.score - visitSum;

            let isBust = false;
            if (remainder < 0) isBust = true;
            else if (state.config.doubleOut) {
                if (remainder === 1) isBust = true;
                if (remainder === 0) {
                    let last = state.currentVisit[state.currentVisit.length-1];
                    let isDouble = (last.mod === 2 && last.raw <= 20) || (last.raw === 50);
                    if (!isDouble) isBust = true;
                }
            }

            if(isBust) { updateUI(); handleBust(); return; }

            // Friss√≠tsd azonnal a statisztik√°t a h√°tt√©rben
            recordDartStat(p.name, dart);
            // Friss√≠tsd a helyi statisztik√°t is a meccsen bel√ºl
            p.totalDarts++; p.totalScore+=dart.score; p.currentLegDarts++;
            if(!p.hits[dart.key]) p.hits[dart.key]=0; p.hits[dart.key]++;

            if(remainder === 0) {
                updateUI(); playSound("win", "Kisz√°ll√≥ megvan!");
                document.getElementById('win-confirm-name').innerText = p.name;
                document.getElementById('win-confirm-modal').style.display = 'flex';
                return;
            }

            if(score === 60 || score === 50) playSound("hit");
            
            // Friss√≠tsd azonnal a statisztik√°t √©s a kijelz≈ët
            updateUI(); 
        }

        function confirmWin() { document.getElementById('win-confirm-modal').style.display = 'none'; commitTurn(true); }
        function cancelWin() { document.getElementById('win-confirm-modal').style.display = 'none'; undoDart(); }

        function handleBust() {
            state.isProcessing = true; playSound("bust", "Sok!");
            setTimeout(() => {
                let p = state.players[state.currIdx];
                state.currentVisit.forEach(d => {
                    p.totalDarts++; p.currentLegDarts++;
                    if(!p.hits[d.key]) p.hits[d.key]=0; p.hits[d.key]++;
                    recordDartStat(p.name, d);
                });
                state.currentVisit = [];
                state.currIdx = (state.currIdx + 1) % state.players.length;
                state.isProcessing = false; updateUI();
            }, 1500);
        }

        function undoDart() { 
            if(state.currentVisit.length>0 && !state.isProcessing) { 
                let dart = state.currentVisit.pop(); 
                
                let p = state.players[state.currIdx];
                p.totalDarts--; p.totalScore-=dart.score; p.currentLegDarts--;
                if(p.hits[dart.key]) p.hits[dart.key]--;
                
                updateUI(); 
            } 
        }
        
        function undoRound() {
            if(state.historyStack.length>0 && !state.isProcessing) {
                let prev = state.historyStack.pop();
                let savedStack = state.historyStack;
                state = prev; state.historyStack = savedStack;
                renderScoreboard(); updateUI();
            }
        }

        function commitTurn(forceWin=false) {
            if(state.isProcessing) return;
            let snap = JSON.parse(JSON.stringify(state)); delete snap.historyStack; delete snap.stream;
            state.historyStack.push(snap); if(state.historyStack.length>10) state.historyStack.shift();

            let p = state.players[state.currIdx];
            let total = state.currentVisit.reduce((a,b)=>a+b.score, 0);
            
            // A statisztik√°t m√°r friss√≠tett√ºk dob√°sonk√©nt az addDart-ban!
            // Csak a 100/140/180-at kell itt menteni.
            recordVisitStat(p.name, total);

            p.score -= total;

            if(forceWin || p.score===0) { handleLegWin(p, total); } 
            else {
                if(total===180) playSound("s180", "Sz√°znyolcvan!"); else playSound(total);
                state.currentVisit=[]; state.currIdx = (state.currIdx+1) % state.players.length; updateUI();
            }
        }

        function handleLegWin(p, lastVisitScore) {
            recordLegWin(p.name, p.currentLegDarts, lastVisitScore);
            p.legs++; p.currentLegDarts = 0; state.currentVisit=[];
            
            if(p.legs >= state.config.legsSet) {
                p.sets++; state.players.forEach(pl=>pl.legs=0);
                if(p.sets >= state.config.setsWin) {
                    saveMatchEnd(p.name); // MECCS V√âGE MENT√âS
                    setTimeout(()=>alert(`üèÜ ${p.name} NYERT! üèÜ`), 500); return;
                }
            }
            setTimeout(() => {
                alert(`Leg: ${p.name}`);
                state.players.forEach(pl => { pl.score = state.config.startScore; pl.currentLegDarts = 0; });
                state.startIdx = (state.startIdx+1) % state.players.length;
                state.currIdx = state.startIdx;
                state.historyStack=[]; updateUI();
            }, 300);
        }

        function renderScoreboard() {
            let container = document.getElementById('scoreboard-container'); container.innerHTML = "";
            let midCheckout = document.getElementById('mid-checkout-display'); 
            midCheckout.innerText = ""; midCheckout.style.display = "none";

            state.players.forEach((p, idx) => {
                let div = document.createElement('div');
                div.className = `player-card ${idx === state.currIdx ? 'active' : ''}`;
                let displayScore = p.score;
                if(idx === state.currIdx) {
                    let visitSum = state.currentVisit.reduce((a,b)=>a+b.score, 0);
                    displayScore -= visitSum;
                }
                let coHtml = "";
                if(state.config.doubleOut && displayScore <= 170 && checkouts[displayScore]) {
                    coHtml = `<div class="checkout-box" style="display:block">${checkouts[displayScore]}</div>`;
                    if(idx === state.currIdx) {
                        midCheckout.innerText = checkouts[displayScore]; midCheckout.style.display = "block";
                    }
                }
                
                let tempTotalScore = p.totalScore;
                let tempTotalDarts = p.totalDarts;
                if (idx === state.currIdx) {
                     let visitSum = state.currentVisit.reduce((a,b)=>a+b.score, 0);
                     tempTotalScore += visitSum;
                     tempTotalDarts += state.currentVisit.length;
                }
                
                let avg = tempTotalDarts > 0 ? (tempTotalScore / tempTotalDarts * 3).toFixed(1) : "0.0";

                div.innerHTML = `
                    <div class="p-name">${p.name}</div>
                    <div class="p-score">${displayScore}</div>
                    <div class="p-avg">Avg: ${avg}</div>
                    <div class="sets-legs">S:${p.sets} | L:${p.legs}</div>
                    ${coHtml}
                `;
                container.appendChild(div);
            });
        }

        function updateUI() {
            renderScoreboard();
            for(let i=0; i<3; i++){
                let slot = document.getElementById(`d${i+1}`);
                if(state.currentVisit[i]) { slot.innerText=state.currentVisit[i].text; slot.classList.add('filled'); }
                else { slot.innerText=""; slot.classList.remove('filled'); }
            }
            let vTot = state.currentVisit.reduce((a,b)=>a+b.score, 0);
            document.getElementById('visit-score').innerText = vTot;

            let isFull = state.currentVisit.length===3;
            document.getElementById('numpad').style.pointerEvents = (isFull||state.isProcessing)?'none':'auto';
            document.getElementById('numpad').style.opacity = (isFull||state.isProcessing)?0.5:1;
            document.getElementById('btn-next').style.display = isFull?'block':'none';
            document.getElementById('btn-undo-round').style.display = (state.historyStack.length>0 && !isFull && state.currentVisit.length===0)?'block':'none';
            document.getElementById('btn-double').classList.toggle('active', state.multiplier===2);
            document.getElementById('btn-triple').classList.toggle('active', state.multiplier===3);
        }

        // --- STATS UI & LOGIC ---
        function showStats() {
            let modal = document.getElementById('stats-modal');
            let nav = document.getElementById('stats-nav');
            let body = document.getElementById('stats-body');
            let allStats = getPersistentStats();
            let players = Object.keys(allStats);
            
            nav.innerHTML = "";
            if(players.length > 0) {
                players.forEach((pName, idx) => {
                    let tab = document.createElement("div");
                    tab.className = `stat-tab ${idx===0 ? 'active' : ''}`;
                    tab.innerText = pName;
                    tab.onclick = () => renderPlayerStats(pName);
                    nav.appendChild(tab);
                });
                renderPlayerStats(players[0]);
            } else {
                body.innerHTML = "<p style='color:white; padding:20px;'>Nincs m√©g r√∂gz√≠tett adat. Dobj p√°rat!</p>";
            }
            
            let historyTab = document.createElement("div");
            historyTab.className = "stat-tab";
            historyTab.innerText = "üìú Napl√≥";
            historyTab.onclick = () => renderMatchHistory();
            nav.appendChild(historyTab);
            
            // √öJ: Dobott tab
            let throwsTab = document.createElement("div");
            throwsTab.className = "stat-tab";
            throwsTab.innerText = "üéØ Dobott";
            throwsTab.onclick = () => renderThrowStats();
            nav.appendChild(throwsTab);
            
            modal.style.display = "block";
        }

        function renderPlayerStats(pName) {
            let allStats = getPersistentStats();
            let p = allStats[pName];
            let body = document.getElementById('stats-body');
            document.querySelectorAll('.stat-tab').forEach(t => t.classList.toggle('active', t.innerText === pName));

            let avg = p.totalDarts > 0 ? (p.totalScore / p.totalDarts * 3).toFixed(2) : "0.00";
            
            body.innerHTML = `
                <div class="stat-grid">
                    <div class="stat-box"><div class="stat-val">${avg}</div><div class="stat-lbl">√Åtlag (3 ny√≠l)</div></div>
                    <div class="stat-box"><div class="stat-val">${p.c180 || 0}</div><div class="stat-lbl">180</div></div>
                    <div class="stat-box"><div class="stat-val">${p.c140 || 0}</div><div class="stat-lbl">140+</div></div>
                    <div class="stat-box"><div class="stat-val">${p.c100 || 0}</div><div class="stat-lbl">100+</div></div>
                    <div class="stat-box"><div class="stat-val">${p.bestLeg === 999 ? '-' : p.bestLeg}</div><div class="stat-lbl">Legjobb Leg</div></div>
                    <div class="stat-box"><div class="stat-val">${p.highestCheckout || 0}</div><div class="stat-lbl">Max Kisz√°ll√≥</div></div>
                    <div class="stat-box"><div class="stat-val">${p.wins || 0}</div><div class="stat-lbl">Gy≈ëzelem</div></div>
                    <div class="stat-box"><div class="stat-val">${p.totalDarts}</div><div class="stat-lbl">√ñsszes Dob√°s</div></div>
                </div>
                <h3>Tal√°lati H≈ët√©rk√©p</h3>
                <div id="heatmap-container"></div>
            `;
            setTimeout(() => drawHeatmap(p.hits), 10);
        }

        function renderMatchHistory() {
            let body = document.getElementById('stats-body');
            document.querySelectorAll('.stat-tab').forEach(t => t.classList.toggle('active', t.innerText.includes("Napl√≥")));
            let history = getMatchHistory();
            
            if(history.length === 0) {
                body.innerHTML = "<p>Nincs m√©g r√∂gz√≠tett meccs.</p>"; return;
            }
            
            let html = `<div class="history-list">`;
            history.forEach(match => {
                let playersInfo = match.players.map(p => `${p.name} (${p.score}, Avg: ${p.avg})`).join(" vs ");
                html += `
                    <div class="history-item">
                        <div class="h-date">${match.date}</div>
                        <div class="h-match">${playersInfo}</div>
                        <div class="h-score">Nyertes: ${match.winner}</div>
                    </div>`;
            });
            html += `</div>`;
            body.innerHTML = html;
        }

        // √öJ: Dobott statisztika
        function renderThrowStats() {
            let body = document.getElementById('stats-body');
            document.querySelectorAll('.stat-tab').forEach(t => t.classList.toggle('active', t.innerText.includes("Dobott")));
            
            let allStats = getPersistentStats();
            let players = Object.keys(allStats);
            if(players.length === 0) { body.innerHTML = "<p>Nincs adat.</p>"; return; }

            // Flatten data: [{player, key, count, val}, ...]
            let flatData = [];
            players.forEach(pName => {
                let hits = allStats[pName].hits;
                for(let key in hits) {
                    // key parse: T20, S5, DBull, MISS...
                    let val = 0;
                    if(key === "MISS" || key === "0") val = 0;
                    else if(key === "SBull" || key === "25") val = 25;
                    else if(key === "DBull" || key === "BULL") val = 50;
                    else {
                        // S20 -> 20, D20 -> 40...
                        let num = parseInt(key.match(/\d+/)[0]);
                        if(key.startsWith('D')) val = num * 2;
                        else if(key.startsWith('T')) val = num * 3;
                        else val = num;
                    }
                    flatData.push({ player: pName, key: key, count: hits[key], val: val });
                }
            });

            // Sorting
            flatData.sort((a, b) => {
                let res = 0;
                if (throwSort.col === 'count') res = b.count - a.count; // count desc by default
                else if (throwSort.col === 'val') res = b.val - a.val;
                else if (throwSort.col === 'key') res = a.key.localeCompare(b.key);
                else if (throwSort.col === 'player') res = a.player.localeCompare(b.player);
                
                return throwSort.asc ? -res : res;
            });

            let html = `
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th class="sortable-th ${throwSort.col==='player'?(throwSort.asc?'asc':'desc'):''}" onclick="sortThrows('player')">J√°t√©kos</th>
                            <th class="sortable-th ${throwSort.col==='key'?(throwSort.asc?'asc':'desc'):''}" onclick="sortThrows('key')">Dob√°s</th>
                            <th class="sortable-th ${throwSort.col==='val'?(throwSort.asc?'asc':'desc'):''}" onclick="sortThrows('val')">√ârt√©k</th>
                            <th class="sortable-th ${throwSort.col==='count'?(throwSort.asc?'asc':'desc'):''}" onclick="sortThrows('count')">Darab</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            flatData.forEach(row => {
                html += `<tr><td>${row.player}</td><td>${row.key}</td><td>${row.val}</td><td>${row.count}</td></tr>`;
            });
            html += `</tbody></table>`;
            
            body.innerHTML = html;
        }

        function sortThrows(col) {
            if (throwSort.col === col) throwSort.asc = !throwSort.asc;
            else { throwSort.col = col; throwSort.asc = false; } // Default desc
            renderThrowStats();
        }

        function drawHeatmap(hits) {
            let container = document.getElementById('heatmap-container');
            if(!container) return;
            container.innerHTML = ""; 
            
            let ns = "http://www.w3.org/2000/svg";
            let svg = document.createElementNS(ns, "svg");
            svg.setAttribute("viewBox", "-200 -200 400 400");
            
            let maxHit = 0;
            for(let key in hits) { if(hits[key] > maxHit) maxHit = hits[key]; }
            
            function getColor(count) {
                if(!count) return "#333";
                let ratio = count / maxHit;
                let hue = 240 - (ratio * 240); 
                return `hsl(${hue}, 70%, 50%)`;
            }
            
            const r_bull = 10; const r_outer = 20; 
            const r_tri_in = 90; const r_tri_out = 100; 
            const r_dbl_in = 150; const r_dbl_out = 160;
            
            sectorOrder.forEach((num, i) => {
                let angleStep = 360 / 20; 
                let startAngleDeg = (i * angleStep) - 90 - (angleStep / 2);
                let endAngleDeg = startAngleDeg + angleStep;
                
                function createArc(innerR, outerR, typePrefix) {
                    let key = typePrefix + num; 
                    let count = hits[key] || 0;
                    let color = getColor(count);
                    
                    let startRad = startAngleDeg * Math.PI / 180;
                    let endRad = endAngleDeg * Math.PI / 180;
                    
                    let x1 = outerR * Math.cos(startRad); let y1 = outerR * Math.sin(startRad);
                    let x2 = outerR * Math.cos(endRad); let y2 = outerR * Math.sin(endRad);
                    let x3 = innerR * Math.cos(endRad); let y3 = innerR * Math.sin(endRad);
                    let x4 = innerR * Math.cos(startRad); let y4 = innerR * Math.sin(startRad);
                    
                    let path = document.createElementNS(ns, "path");
                    let d = `M ${x1} ${y1} A ${outerR} ${outerR} 0 0 1 ${x2} ${y2} L ${x3} ${y3} A ${innerR} ${innerR} 0 0 0 ${x4} ${y4} Z`;
                    path.setAttribute("d", d); path.setAttribute("fill", color); path.setAttribute("stroke", "#111"); path.setAttribute("stroke-width", "1");
                    let title = document.createElementNS(ns, "title"); title.textContent = `${key}: ${count}`; path.appendChild(title);
                    svg.appendChild(path);
                }
                
                createArc(r_dbl_in, r_dbl_out, "D"); 
                createArc(r_tri_out, r_dbl_in, "S"); 
                createArc(r_tri_in, r_tri_out, "T"); 
                createArc(r_outer, r_tri_in, "S");
                
                let textR = 180;
                let midAngleRad = (startAngleDeg + angleStep/2) * Math.PI / 180;
                let tx = textR * Math.cos(midAngleRad); let ty = textR * Math.sin(midAngleRad);
                let text = document.createElementNS(ns, "text");
                text.setAttribute("x", tx); text.setAttribute("y", ty); text.setAttribute("class", "sector-text"); text.textContent = num;
                svg.appendChild(text);
            });
            
            function createCircle(r, key) {
                let count = hits[key] || 0;
                let circle = document.createElementNS(ns, "circle");
                circle.setAttribute("cx", 0); circle.setAttribute("cy", 0); circle.setAttribute("r", r);
                circle.setAttribute("fill", getColor(count)); circle.setAttribute("stroke", "#111");
                let title = document.createElementNS(ns, "title"); title.textContent = `${key}: ${count}`; circle.appendChild(title);
                svg.appendChild(circle);
            }
            createCircle(r_outer, "SBull"); createCircle(r_bull, "DBull");
            container.appendChild(svg);
        }
        function closeStats(){document.getElementById('stats-modal').style.display="none";}

        function playSound(key, fallback) {
            if(key==="s180" && sounds.s180){sounds.s180.play(); return;}
            if(key==="win" && sounds.win){sounds.win.play(); return;}
            if(key==="bust" && sounds.bust){sounds.bust.play(); return;}
            if(typeof key==='number'){
                let u = new SpeechSynthesisUtterance(key.toString()); u.lang='hu-HU'; u.rate=1.1; window.speechSynthesis.speak(u);
            }
        }
    </script>
</body>
</html>